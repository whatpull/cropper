<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Auto Cropper</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="./css/common.css" rel="stylesheet" />
        <link href="./subproject/css/product_detail.css" rel="stylesheet" />

        <script src="http://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>

        <!-- 공통 -->
        <script type="text/javascript" src="./js/common.js"></script>

        <!-- 셀렉트박스 모듈 -->
        <!-- <script type="text/javascript" src="./js/selectbox_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/selectbox.css" /> -->

        <!-- 테이블 모듈 -->
        <script type="text/javascript" src="./js/table_core_module.js"></script>
        <link href="./css/table.css" rel="stylesheet" />

        <!-- 팝업 모듈 -->
        <script type="text/javascript" src="./js/popup_core_module.js"></script>
        <link href="./css/popup.css" rel="stylesheet" />

        <script>
            window.onload = function() {
                const host = window.location.host;

                common.menu();
                common.expander();
                
                // 아이디를 통해 크리에이터 정보 조회
                const id = window.location.search.substring(1).split("=")[1];
                
                // 데이터 획득
                function fetch(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                const result = JSON.parse(xhr.responseText);
                                const data = result.result;
                                parsing(data);
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/product/" + id, true);
                    xhr.send();
                }
                fetch(id);

                // 데이터 파싱[+ UI생성]
                function parsing(data) {
                    document.querySelector("#product-thumbnail").style.backgroundImage = "url('" + data.productImagePath + "')";
                    document.querySelector("#product-name").innerText = data.name;
                    document.querySelector("#product-creator").innerText = data.creatorName + " ‧ " + data.packageCreatorName;
                    document.querySelector("#product-cost").innerText = common.numberWithCommas(data.productPrice.cost) + "원";
                    document.querySelector("#product-price").innerHTML = common.numberWithCommas(data.productPrice.price) + "원";

                    const option_list = document.querySelector("#option-list");
                    option_list.innerHTML = "";

                    const options = data.productOptions;
                    for(option of options) {
                        let img = option.imagePath + option.mockupImage;
                        if(host === "127.0.0.1:5500" 
                                || host === "localhost:5500" 
                                || host === "192.167.0.177:5500") {
                                    img = "/cropper/src" + img;
                        }

                        const download_btn = document.createElement("div");
                        download_btn.innerText = "";
                        download_btn.setAttribute("data-url", img);
                        download_btn.style.position = "absolute";
                        download_btn.style.top = "50px";
                        download_btn.style.right = "20px";
                        download_btn.style.width = "20px";
                        download_btn.style.minHeight = "20px";
                        // download_btn.style.backgroundColor = "#8fd5b5";
                        // download_btn.style.borderRadius = "50%";
                        download_btn.style.backgroundImage = "url('./img/icon-download.png')";
                        download_btn.style.backgroundSize = "cover";
                        download_btn.style.backgroundRepeat = "no-repeat";
                        download_btn.style.backgroundPosition = "center";
                        download_btn.style.color = "#FFFFFF";
                        download_btn.style.display = "flex";
                        download_btn.style.justifyContent = "center";
                        download_btn.style.alignItems = "center";
                        download_btn.style.cursor = "pointer";
                        download_btn.style.zIndex = "4";
                        download_btn.addEventListener("click", function(e) {
                            e.preventDefault();
                            // 파일 다운로드 구현
                            const url = this.getAttribute("data-url");
                            var link = document.createElement('a');
                            link.style.width = "0px";
                            link.style.height = "0px";
                            link.style.visibility = "hidden";
                            link.href = url;
                            link.download = 'product_image.png';
                            // 이벤트 루프 방지용(클릭시 이벤트 전파를 막습니다.)
                            link.addEventListener("click", function(e) {
                                e.stopPropagation();
                            });
                            this.appendChild(link);
                            link.click();
                            this.removeChild(link);
                        });

                        const edit_btn = document.createElement("div");
                        edit_btn.innerText = "";
                        edit_btn.style.position = "absolute";
                        edit_btn.style.top = "20px";
                        edit_btn.style.right = "20px";
                        edit_btn.style.width = "20px";
                        edit_btn.style.minHeight = "20px";
                        // edit_btn.style.backgroundColor = "#8fd5b5";
                        // edit_btn.style.borderRadius = "50%";
                        edit_btn.style.backgroundImage = "url('./img/icon-edit.png')";
                        edit_btn.style.backgroundSize = "cover";
                        edit_btn.style.backgroundRepeat = "no-repeat";
                        edit_btn.style.backgroundPosition = "center";
                        edit_btn.style.color = "#FFFFFF";
                        edit_btn.style.display = "flex";
                        edit_btn.style.justifyContent = "center";
                        edit_btn.style.alignItems = "center";
                        edit_btn.style.cursor = "pointer";
                        edit_btn.style.zIndex = "4";
                        edit_btn.setAttribute("data-id", option.id);
                        edit_btn.addEventListener("click", function(e) {
                            e.preventDefault();

                            const optionId = this.getAttribute("data-id");
                            for(option of options) {
                                if(option.id == optionId) {
                                    const form = document.querySelector("#option-editor");
                                    form.querySelector("#editor-option-id").value = option.id;
                                    form.querySelector("#editor-option1-name").value = option.option_name1;
                                    form.querySelector("#editor-option2-name").value =  (option.option_name2 == "null" ? "" : option.option_name2);
                                    form.querySelector("#editor-image-path").value = option.imagePath;
                                    form.querySelector("#editor-mockup-image").value = option.mockupImage;
                                    form.querySelector("#editor-option-status").value = option.status;
                                }
                            }

                            popup_editor.open();
                        });

                        const option_item_div = document.createElement("div");
                        option_item_div.id = "option-item";
                        option_item_div.style.position = "relative";
                        option_item_div.style.backgroundImage = "url('" + img + "')";
                        option_item_div.style.backgroundPosition = "center";
                        option_item_div.style.backgroundSize = "cover";
                        option_item_div.classList.add("option-item");

                        const hover_div = document.createElement("div");
                        hover_div.classList.add("hover-div");

                        const hover_option_name = document.createElement("div");
                        hover_option_name.classList.add("hover-option-name");
                        hover_option_name.innerText = option.option_name1 + (option.option_name2 == "null" ? "" : " - " + option.option_name2);

                        const hover_option_package_creator = document.createElement("div");
                        hover_option_package_creator.classList.add("hover-option-package-creator");
                        hover_option_package_creator.innerText = data.creatorName;

                        hover_div.appendChild(hover_option_name);
                        hover_div.appendChild(hover_option_package_creator);

                        option_item_div.appendChild(download_btn);
                        option_item_div.appendChild(edit_btn);
                        option_item_div.appendChild(hover_div);

                        option_list.appendChild(option_item_div);
                    }
                }

                const popup_editor = new Popup("옵션 수정");
                // 실제 팝업창에 그려질 form 문 작성
                popup_editor.init(function(popup) {
                    const form = document.createElement("form");
                    form.id = "option-editor";
                    form.style.display = "flex";
                    form.style.flexDirection = "column";
                    form.style.alignItems = "center";
                    form.style.padding = "0px 30px";

                    // 번호
                    const id_div = document.createElement("div");
                    id_div.style.marginTop = "45px";
                    const id_label = document.createElement("div");
                    id_label.innerText = "번호";
                    id_label.classList.add("popup-label");
                    const id = document.createElement("input");
                    id.id = "editor-option-id";
                    id.classList.add("popup-input");
                    id.setAttribute("name", "id");
                    id.setAttribute("autocomplete", "off");
                    id.readOnly = true;
                    id_div.appendChild(id_label);
                    id_div.appendChild(id);

                    // 옵션 이름1
                    const option1_div = document.createElement("div");
                    option1_div.style.marginTop = "20px";
                    const option1_label = document.createElement("div");
                    option1_label.innerText = "옵션 이름1";
                    option1_label.classList.add("popup-label");
                    const option1 = document.createElement("input");
                    option1.id = "editor-option1-name";
                    option1.classList.add("popup-input");
                    option1.setAttribute("name", "optionName1");
                    option1.setAttribute("autocomplete", "off");
                    option1_div.appendChild(option1_label);
                    option1_div.appendChild(option1);

                    // 옵션 이름2
                    const option2_div = document.createElement("div");
                    option2_div.style.marginTop = "20px";
                    const option2_label = document.createElement("div");
                    option2_label.innerText = "옵션 이름2";
                    option2_label.classList.add("popup-label");
                    const option2 = document.createElement("input");
                    option2.id = "editor-option2-name";
                    option2.classList.add("popup-input");
                    option2.setAttribute("name", "optionName2");
                    option2.setAttribute("autocomplete", "off");
                    option2_div.appendChild(option2_label);
                    option2_div.appendChild(option2);

                    // 이미지 경로(상대경로)
                    const image_path_div = document.createElement("div");
                    image_path_div.style.marginTop = "20px";
                    const image_path_label = document.createElement("div");
                    image_path_label.innerText = "이미지 경로";
                    image_path_label.classList.add("popup-label");
                    const image_path = document.createElement("input");
                    image_path.id = "editor-image-path";
                    image_path.classList.add("popup-input");
                    image_path.setAttribute("name", "imagePath");
                    image_path.setAttribute("autocomplete", "off");
                    image_path_div.appendChild(image_path_label);
                    image_path_div.appendChild(image_path);

                    // 완성된 상품 이미지
                    const mockup_image_div = document.createElement("div");
                    mockup_image_div.style.marginTop = "20px";
                    const mockup_image_label = document.createElement("div");
                    mockup_image_label.innerText = "상품 이미지";
                    mockup_image_label.classList.add("popup-label");
                    const mockup_image = document.createElement("input");
                    mockup_image.id = "editor-mockup-image";
                    mockup_image.classList.add("popup-input");
                    mockup_image.setAttribute("name", "mockupImage");
                    mockup_image.setAttribute("autocomplete", "off");
                    mockup_image_div.appendChild(mockup_image_label);
                    mockup_image_div.appendChild(mockup_image);

                    // 상태
                    const status_div = document.createElement("div");
                    status_div.style.marginTop = "20px";
                    const status_label = document.createElement("div");
                    status_label.innerText = "상태(Y, N)";
                    status_label.classList.add("popup-label");
                    const status = document.createElement("input");
                    status.id = "editor-option-status";
                    status.classList.add("popup-input");
                    status.setAttribute("name", "status");
                    status.setAttribute("autocomplete", "off");
                    status_div.appendChild(status_label);
                    status_div.appendChild(status);

                    // 버튼
                    const submit_btn = document.createElement("div");
                    submit_btn.innerText = "완료";
                    submit_btn.classList.add("popup-button");
                    submit_btn.addEventListener("click", function(e) {
                        e.preventDefault();

                        // 하나씩 파싱해서 데이터 저장
                        const form = document.querySelector("#option-editor");
                        const option_id = form.querySelector("#editor-option-id").value;
                        const option_name1 = form.querySelector("#editor-option1-name").value;
                        const option_name2 = form.querySelector("#editor-option2-name").value;
                        const image_path = form.querySelector("#editor-image-path").value;
                        const mockup_image = form.querySelector("#editor-mockup-image").value;
                        const status = form.querySelector("#editor-option-status").value;

                        var data = new FormData();

                        if(option_id !== "") {
                            data.append("id", option_id);
                        }
                        if(option_name1 !== "") {
                            data.append("optionName1", option_name1);
                        }
                        if(option_name2 !== "") {
                            data.append("optionName2", option_name2);
                        }
                        if(image_path !== "") {
                            data.append("imagePath", image_path);
                        }
                        if(mockup_image !== "") {
                            data.append("mockupImage", mockup_image);
                        }
                        if(status !== "") {
                            data.append("status", status);
                        }

                        sendEditor(data);
                    });

                    // 데이터 전송
                    function sendEditor(data) {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if(xhr.status == 200) {
                                    const id = window.location.search.substring(1).split("=")[1];
                                    const result = JSON.parse(xhr.responseText);
                                    popup_editor.close();
                                    fetch(id);
                                    alert("수정에 성공하였습니다.");
                                } else {
                                    alert("수정에 실패하였습니다.");
                                }
                            }
                        }
                        xhr.open("PUT", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/product/option", true);
                        xhr.send(data);
                    }

                    form.appendChild(id_div);
                    form.appendChild(option1_div);
                    form.appendChild(option2_div);
                    form.appendChild(image_path_div);
                    form.appendChild(mockup_image_div);
                    form.appendChild(status_div);
                    form.appendChild(submit_btn);

                    popup.appendChild(form);
                });
            }
        </script>
    </head>
    <body class="ac">
        <div class="wrapper">
            <div class="head">
                Auto Cropper
            </div>
            <div class="menu">
                <div class="logo">
                    <img src="./img/ac-logo.png">
                </div>
                <div class="platform">
                    <img src="./img/ac-platform.png">
                </div>
                <div class="menu-item" data-page="creator">
                    <div class="menu-item-icon">
                        <img src="./img/menu-icon-creator.png">
                    </div>
                    <div class="menu-item-text">
                        Creator
                    </div>
                </div>
                <div class="menu-item" data-page="maker">
                    <div class="menu-item-icon">
                        <img src="./img/menu-icon-maker.png">
                    </div>
                    <div class="menu-item-text">
                        Maker
                    </div>
                </div>
                <div class="menu-item" data-page="package">
                    <div class="menu-item-icon">
                        <img src="./img/menu-icon-package.png">
                    </div>
                    <div class="menu-item-text">
                        Package
                    </div>
                </div>
                <div class="menu-item" data-page="edit">
                    <div class="menu-item-icon">
                        <img src="./img/menu-icon-edit.png">
                    </div>
                    <div class="menu-item-text">
                        Edit
                    </div>
                </div>
                <div class="menu-item" data-page="auto">
                    <div class="menu-item-icon">
                        <img src="./img/menu-icon-auto.png">
                    </div>
                    <div class="menu-item-text">
                        Auto
                    </div>
                </div>
                <div class="menu-item active" data-page="product">
                    <div class="menu-item-icon">
                        <img src="./img/menu-icon-product-active.png">
                    </div>
                    <div class="menu-item-text">
                        Product
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="info">
                    <div class="product">
                        <div id="product-thumbnail" class="thumbnail">
                            <img src="./img/icon-profile-empty.png">
                        </div>
                        <div class="product-data">
                            <div id="product-name" class="name"></div>
                            <div id="product-creator" class="creator"></div>
                        </div>
                        <div class="price">
                            <div id="product-cost"></div>
                            <div id="product-price"></div>
                        </div>
                    </div>
                    <div class="update">
                        <!-- <div id="price-update-btn" class="price-update-btn"></div> -->
                    </div>
                </div>
                <div class="data">
                    <div id="option-list" class="option-list">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>