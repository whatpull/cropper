<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Auto Cropper</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="./css/common.css" rel="stylesheet" />
        <link href="./css/edit.css" rel="stylesheet" />

        <!-- 공통 -->
        <script type="text/javascript" src="./js/common.js"></script>

        <!-- 오토크로퍼 모듈 -->
        <script type="text/javascript" src="./js/cropper_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/cropper.css" />

        <!-- 셀렉트박스 모듈 -->
        <script type="text/javascript" src="./js/selectbox_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/selectbox.css" />

        <!-- 팔레트 모듈 -->
        <link rel="stylesheet" href="./libs/pickr/themes/classic.min.css"/> <!-- 'classic' theme -->
        <link rel="stylesheet" href="./libs/pickr/themes/monolith.min.css"/> <!-- 'monolith' theme -->
        <link rel="stylesheet" href="./libs/pickr/themes/nano.min.css"/> <!-- 'nano' theme -->
        <script src="./libs/pickr/pickr.min.js"></script>
        <script src="./libs/pickr/pickr.es5.min.js"></script>

        <script>
            window.onload = function() {
                const host = window.location.host;

                common.menu();
                common.expander();

                palette_color = {
                    color01: "#ffffff",
                    color02: "#B6B5B5",
                    color03: "#54B689",
                    color04: "#A093D6",
                    color05: "#7BB2E3",
                    color06: "#D34249",
                }

                // [이벤트] 버튼 클릭 - 정보 조회
                document.querySelector("#btn-ac-info").addEventListener("click", function(e) {
                    const info = editor.info();
                    document.querySelector("#ac-info-top").innerText = info.top;
                    document.querySelector("#ac-info-left").innerText = info.left;
                    document.querySelector("#ac-info-width").innerText = info.width;
                    document.querySelector("#ac-info-height").innerText = info.height;
                    document.querySelector("#ac-info-color").innerText = info.color;
                });

                // [셀렉트 박스] 상품
                let editor; // 에디터 변수
                const product = new SelectBox("selectbox-product", function(value) {
                    const productId = value.split("_")[0];
                    const optionIndex = value.split("_")[1];

                    // 정보조회 초기화
                    document.querySelector("#ac-info-top").innerText = "0";
                    document.querySelector("#ac-info-left").innerText = "0";
                    document.querySelector("#ac-info-width").innerText = "0";
                    document.querySelector("#ac-info-height").innerText = "0";
                    document.querySelector("#ac-info-color").innerText = "#";

                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if(xhr.status == 200) {
                                const result = JSON.parse(xhr.responseText);
                                // 우선순위를 구분할 수 있는 방법이 없어서 첫번째 리소스 활용
                                const option = result.result.packageOptions[optionIndex];

                                if(typeof option === "undefined") {
                                    // 옵션 데이터가 없는 경우
                                } else {
                                    let path = option.imagePath;
                                    const mock_img = option.mockupImage.find(item => item.indexOf("_effect") == -1 && item.indexOf("_area") == -1);
                                    const area_img = option.mockupImage.find(item => item.indexOf("_area") > -1);
                                    const effect_img = option.mockupImage.find(item => item.indexOf("_effect") > -1);
                                    const color_code = option.mockFilling;

                                    if(host === "127.0.0.1:5500" 
                                        || host === "localhost:5500" 
                                        || host === "192.167.0.177:5500") {
                                        path = "/cropper/src" + path;
                                    }

                                    if(typeof editor === "undefined") {

                                    } else {
                                        editor.destroy();
                                    }
                                    
                                    editor = new Cropper({
                                        mode: "editor",
                                        mock_img: path + mock_img,
                                        area_img: path + area_img,
                                        effect_img: path + effect_img,
                                        color_code: color_code
                                    }, {
                                        top: parseFloat(option.mockTop),
                                        left: parseFloat(option.mockLeft),
                                        width: parseFloat(option.mockWidth),
                                        height: parseFloat(option.mockHeight)
                                    }, palette_color);
                                    editor.init();
                                }
                            } else {
                                console.log("xhr error");
                            }
                        }
                    };
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/package/" + productId, true);
                    xhr.send();
                });
                product.init("http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/packages?size=2147483647", function(list, target) { 
                    const option_default = document.createElement("option");
                    option_default.innerText = "상품";
                    target.appendChild(option_default);
    
                    for(item of list) {
                        const data_options = item.packageOptions;
                        const data_options_size = data_options.length
                        const package_id = item.id;
                        for(index in data_options) {
                            const data_option = data_options[index];
                            const option_index = index;
                            const option = document.createElement("option");
                            option.value = package_id + "_" + option_index;
                            option.innerText = data_option.optionName1 + " - " + data_option.optionName2;
                            target.appendChild(option);
                        }
                    }
                });
            }
        </script>
    </head>
    <body class="ac">
        <div class="wrapper">
            <div class="head">
                Auto Cropper
            </div>
            <div class="menu">
                <div class="logo">
                    
                </div>
                <div class="platform">
                    AfreecaTV
                </div>
                <div class="menu-item" data-page="creator">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            people
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Creator
                    </div>
                </div>
                <div class="menu-item" data-page="maker">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            build
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Maker
                    </div>
                </div>
                <div class="menu-item" data-page="package">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            how_to_vote
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Package
                    </div>
                </div>
                <div class="menu-item active" data-page="edit">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            crop_free
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Edit
                    </div>
                </div>
                <div class="menu-item" data-page="auto">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            style
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Auto
                    </div>
                </div>
                <div class="menu-item" data-page="product">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            local_mall
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Product
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="editor">

                </div>
            </div>
            <div class="nav">
                <div class="nav-body">
                    <div class="nav-body-content">
                        <div class="ac-selector selectbox-product">
                            <select id="select">
                                <option value="">상품</option>
                                <option value="0">아이폰 11</option>
                                <option value="1">파우치</option>
                                <option value="2">쿠션</option>
                                <option value="3">담요</option>
                                <option value="4">캔버스</option>
                            </select>
                        </div>
                        <div class="ac-info">
                            <div class="ac-info-item">
                                T(top) : <div id="ac-info-top" class="value">0</div>
                            </div>
                            <div class="ac-info-item">
                                L(left) : <div id="ac-info-left" class="value">0</div>
                            </div>
                            <div class="ac-info-item">
                                W(width) : <div id="ac-info-width" class="value">0</div>
                            </div>
                            <div class="ac-info-item">
                                H(height) : <div id="ac-info-height" class="value">0</div>
                            </div>
                            <div class="ac-info-item">
                                C(color) : <div id="ac-info-color" class="value">#</div>
                            </div>
                        </div>
                        <div id="btn-ac-info" class="ac-info-button">
                            정보 조회
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>