<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Auto Cropper</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="./css/common.css" rel="stylesheet" />
        <link href="./css/auto.css" rel="stylesheet" />

        <!-- 공통 -->
        <script type="text/javascript" src="./js/common.js"></script>

        <!-- 오토크로퍼 모듈 -->
        <script type="text/javascript" src="./js/cropper_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/cropper.css" />

        <!-- 셀렉트박스 모듈 -->
        <script type="text/javascript" src="./js/selectbox_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/selectbox.css" />

        <!-- 모멘트JS -->
        <script src="./libs/moment/moment.min.js"></script>

        <script>
            window.onload = function() {
                const host = window.location.host;

                common.menu();
                common.expander();

                const editor = document.querySelector(".editor");
                editor.style.justifyContent = "flex-start";
                editor.style.alignItems = "flex-start";
                editor.style.height = "initial";
                editor.style.width = "calc(100% - 20px)";
                editor.style.maxHeight = "calc(100vh - 20px)";
                editor.style.padding = "10px";

                palette_color = {
                    color01: "#ffffff",
                    color02: "#B6B5B5",
                    color03: "#54B689",
                    color04: "#A093D6",
                    color05: "#7BB2E3",
                    color06: "#D34249",
                }

                let iphone_11pro, pouch, cushion, blanket;
                let croppers = [];

                // [미리보기]
                function preview(asset_img) {
                    fetchOptions(asset_img);
                }

                // [옵션 조회] 전체 조회
                function fetchOptions(asset_img) {
                    return new Promise(function(resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if(xhr.status == 200) {
                                    const result = JSON.parse(xhr.responseText);
                                    const contents = result.content;
                                    for(content of contents) {
                                        // 패키지 아이디, 패키지 크리에이터 아이디
                                        const packageId = content.id;
                                        const packageCreatorId = content.packageCreator.id;
                                        const packageName = content.name;

                                        options = content.packageOptions;
                                        for(option of options) {
                                            let path = option.imagePath;
                                            const mock_img = option.mockupImage.find(item => item.indexOf("effect") == -1 && item.indexOf("area") == -1);
                                            const area_img = option.mockupImage.find(item => item.indexOf("area") > -1);
                                            const effect_img = option.mockupImage.find(item => item.indexOf("effect") > -1);
                                            const color_code = option.mockFilling;

                                            if(host === "127.0.0.1:5500" 
                                                || host === "localhost:5500" 
                                                || host === "192.167.0.177:5500") {
                                                path = "/cropper/src" + path;
                                            }

                                            const temp = new Cropper({
                                                mode: "autopacking",
                                                mock_img: path + mock_img,
                                                area_img: path + area_img,
                                                asset_img: asset_img,
                                                effect_img: path + effect_img,
                                                color_code: color_code
                                            }, {
                                                top: parseFloat(option.mockTop),
                                                left: parseFloat(option.mockLeft),
                                                width: parseFloat(option.mockWidth),
                                                height: parseFloat(option.mockHeight)
                                            }, palette_color);
                                            temp.init();
                                            temp.setParam({
                                                "packageId": packageId,
                                                "packageCreatorId": packageCreatorId,
                                                "packageName": packageName
                                            });
                                            // 활용 데이터 입력
                                            croppers.push(temp);
                                        }
                                    }
                                    resolve("success");
                                } else {
                                    reject("error");
                                }
                            }
                        }
                        xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/packages?size=2147483647", true);
                        xhr.send();
                    });
                }

                // [옵션 조회] 단일 조회(아이디)
                function fetchOption(id, asset_img) {
                    return new Promise(function(resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if(xhr.status == 200) {
                                    const result = JSON.parse(xhr.responseText);
                                    const packageId = result.result.id;
                                    const packageCreatorId = result.result.packageCreator.id;
                                    const packageName = result.result.name;

                                    const options = result.result.packageOptions;
                                    for(option of options) {
                                        let path = option.imagePath;
                                        const mock_img = option.mockupImage.find(item => item.indexOf("effect") == -1 && item.indexOf("area") == -1);
                                        const area_img = option.mockupImage.find(item => item.indexOf("area") > -1);
                                        const effect_img = option.mockupImage.find(item => item.indexOf("effect") > -1);
                                        const color_code = option.mockFilling;

                                        if(host === "127.0.0.1:5500" 
                                            || host === "localhost:5500" 
                                            || host === "192.167.0.177:5500") {
                                            path = "/cropper/src" + path;
                                        }

                                        const temp = new Cropper({
                                            mode: "autopacking",
                                            mock_img: path + mock_img,
                                            area_img: path + area_img,
                                            asset_img: asset_img,
                                            effect_img: path + effect_img,
                                            color_code: color_code
                                        }, {
                                            top: parseFloat(option.mockTop),
                                            left: parseFloat(option.mockLeft),
                                            width: parseFloat(option.mockWidth),
                                            height: parseFloat(option.mockHeight)
                                        }, palette_color);
                                        temp.init();
                                        temp.setParam({
                                            "packageId": packageId,
                                            "packageCreatorId": packageCreatorId,
                                            "packageName": packageName
                                        });
                                        croppers.push(temp);
                                    }
                                    resolve("success");
                                } else {
                                    reject("error");
                                }
                            }
                        }
                        xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/package/" + id, true);
                        xhr.send();
                    });
                }

                // [미리보기 파괴] 
                function preview_destroy() {
                    const size = croppers.length;
                    for(let i = 0; i < size; i++) {
                        croppers[i].destroy();
                    }
                    croppers = [];
                }

                const product = new SelectBox("selectbox-creator", function(value) {
                    fetch(value);
                });
                product.init("http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/productCreators?size=2147483647", function(list, target) {
                    const option_default = document.createElement("option");
                    option_default.innerText = "크리에이터";
                    target.appendChild(option_default);
    
                    for(item of list) {
                        const option = document.createElement("option");
                        option.value = item.id;
                        option.innerText = item.userId + "(" + item.creatorName + ")";
                        target.appendChild(option);
                    }
                });

                function fetch(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if(xhr.status == 200) {
                                const result = JSON.parse(xhr.responseText);
                                const assets = result.content;

                                const assets_div = document.querySelector("#ac-assets");
                                assets_div.innerHTML = "";
                                for(index in assets) {
                                    const asset = assets[index];
                                    let assetPath = asset.assetPath;
                                    const assetFileName = asset.assetFileName;
                                    const asset_div = document.createElement("div");
                                    asset_div.id = "asset-div-" + asset.asset_id;
                                    asset_div.classList.add("asset-item");

                                    if(index == 0) { // 초기 데이터 설정
                                        asset_div.classList.add("active");
                                    }

                                    if(host === "127.0.0.1:5500" 
                                        || host === "localhost:5500" 
                                        || host === "192.167.0.177:5500") {
                                        assetPath = "/cropper/src" + assetPath;
                                    }
                                    
                                    asset_div.setAttribute("data-asset", assetPath + assetFileName);
                                    asset_div.setAttribute("data-name", asset.name);
                                    asset_div.addEventListener("click", function(e) {
                                        // UI 선택
                                        const list = document.querySelectorAll(".asset-item");
                                        for(item of list) {
                                            if(item.classList.contains("active")) {
                                                item.classList.remove("active");
                                            }
                                        }
                                        this.classList.add("active");

                                        preview_destroy();
                                        preview(this.getAttribute("data-asset"));
                                    });
                                    asset_div.style.backgroundImage = "url('" + assetPath + assetFileName + "')";
                                    assets_div.appendChild(asset_div);
                                }

                                if(typeof assets[0] === "object") {
                                    let assetUrl = assets[0].assetPath + assets[0].assetFileName;
                                    preview_destroy();
                                    if(host === "127.0.0.1:5500" 
                                        || host === "localhost:5500" 
                                        || host === "192.167.0.177:5500") {
                                        assetUrl = "/cropper/src" + assetUrl;
                                    }
                                    preview(assetUrl);
                                } 
                                // 준비
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    // xhr.open("GET", "data/autocropper_assets.json", true);
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/assets?productCreatorId=" + id, true);
                    xhr.send();
                }

                // [이벤트] 업로드 버튼 클릭
                let isRun = false;
                let temp_productIds = [];
                document.querySelector("#btn-ac-upload").addEventListener("click", function(e) {
                    // 중복 클릭 방지
                    if(isRun == true) {
                        return;
                    }
                    isRun = true;

                    // 1번 상품 생성
                    // 필요 데이터 수집
                    const creator_select = document.querySelector(".selectbox-creator #select");
                    const creatorId = creator_select.options[creator_select.selectedIndex].value;

                    let temp_array = {"param": []};
                    for(cropper of croppers) {
                        cropper.setBlob(); // 이미지 데이터 변수에 저장
                        const param = cropper.getParam();
                        temp_array.param.push(param);
                    }
                    temp_array = common.uniqueArray(temp_array);

                    // 어셋 이름 획득
                    const assetName = document.querySelector("#ac-assets .asset-item.active").getAttribute("data-name");

                    // 상품 생성 + 상품 아이디 데이터 저장
                    const promise_array = [];
                    for(temp of temp_array) {
                        // asset_name_pakage_name
                        // 변수 생성
                        const param = new FormData();
                        param.append("creatorId", creatorId);
                        param.append('name', assetName + "_" + temp.packageName);
                        param.append('detail', "미정");
                        param.append('image', temp.image, "product_thumbnail.png");
                        param.append("packageCreatorId", temp.packageCreatorId);
                        param.append("packageId", temp.packageId);

                        promise_array.push(postProduct(param, temp));
                    }

                    // 프로미스 처리 일괄 데이터 성공유무 체크
                    Promise.all(promise_array).then(function(values) {
                        alert("상품 등록에 성공하였습니다.");
                        isRun = false;
                        error = 0;
                    }).catch(function(error) {
                        if(error.type === "option") {
                            for(temp_productId of temp_productIds) {
                                var xhr = new XMLHttpRequest();
                                xhr.onreadystatechange = function(e) {
                                    if (xhr.readyState == 4) {
                                        if(xhr.status == 200) {
                                            const result = JSON.parse(xhr.responseText);
                                        } else {
                                            console.log("xhr error");
                                        }
                                    }
                                }
                                xhr.open("DELETE", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/product/" + temp_productId, true);
                                xhr.send();
                            }
                        }
                        alert("상품 등록에 실패하였습니다.");
                        isRun = false;
                        error = 0;
                    }.bind(temp_productIds));
                });

                // [서비스] 상품 생성
                // [크로스 오리진 에러 공유]
                function postProduct(param, temp) {
                    return new Promise(function(resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if(xhr.status == 200) {
                                    const result = JSON.parse(xhr.responseText);

                                    // 1. 상품 아이디 생성
                                    const productId = result.result.id;
                                    temp_productIds.push(productId);
                                    // 2. 옵션이름1, 옵션이름2 // start-date, end-date 처리를 어떻게 할 것인가? (입력받기에는 너무 많은 숫자)
                                    const optionName1 = "미정";
                                    const optionName2 = "미정";
                                    // 현재 달의 첫번째일 - 1달, 마지막일 + 1달
                                    const startDate = moment().startOf('month').subtract(1, 'month').format("YYYYMMDDHHmmss");
                                    const endDate = moment().endOf('month').add(900, 'years').format("YYYYMMDDHHmmss");
                                    
                                    // 상품 생성[프로덕트 아이디를 일치시키위한 작업]
                                    const promise_array = [];
                                    for(cropper of croppers) {
                                        if(JSON.stringify(temp) === JSON.stringify(cropper.getParam())) {
                                            // 변수 생성
                                            const param = new FormData();
                                            param.append("productId", productId);
                                            param.append('optionName1', optionName1);
                                            param.append("optionName2", optionName2);
                                            param.append('image', cropper.getParam().image, "option_thumbnail.png");
                                            param.append("startDate", startDate);
                                            param.append("endDate", endDate);
                                            
                                            promise_array.push(postOption(param));
                                        }
                                    }

                                    // 프로미스 처리 일괄 데이터 성공유무 체크
                                    Promise.all(promise_array).then(function(values) {
                                        resolve(productId);
                                    }.bind(resolve), function(values) {
                                        reject({
                                            "type": "option",
                                            "productId": productId
                                        });
                                    }.bind(reject));
                                } else {
                                    reject({
                                        "type": "product"
                                    });
                                }
                            }
                        }
                        xhr.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/product", true);
                        xhr.send(param);
                    });
                }

                // [서비스] 옵션 생성
                function postOption(param) {
                    return new Promise(function(resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if(xhr.status == 200) {
                                    const result = JSON.parse(xhr.responseText);
                                    resolve("success");
                                } else {
                                    reject("error");
                                }
                            }
                        }
                        xhr.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/product/option", true);
                        xhr.send(param);
                    });
                }
            }
        </script>
    </head>
    <body class="ac">
        <div class="wrapper">
            <div class="content">
                <div class="editor">

                </div>
            </div>
            <div class="nav">
                <div class="nav-head">
                    <div id="btn-ac-expander" class="nav-head-expander">
                        <i id="btn-ac-expander-icon" class="material-icons">
                            last_page
                        </i>
                    </div>
                    <div class="nav-head-logo">
                        Auto Cropper
                    </div>
                </div>
                <div class="nav-body">
                    <div class="nav-body-menu">
                        <div class="menu-item" data-page="edit">
                            <i class="material-icons">
                                crop_free
                            </i>
                            edit
                        </div>
                        <div class="menu-item active" data-page="auto">
                            <i class="material-icons">
                                style
                            </i>
                            auto
                        </div>
                        <div class="menu-item" data-page="creator">
                            <i class="material-icons">
                                people
                            </i>
                            creator
                        </div>
                        <div class="menu-item" data-page="maker">
                            <i class="material-icons">
                                build
                            </i>
                            maker
                        </div>
                        <div class="menu-item" data-page="product">
                            <i class="material-icons">
                                local_mall
                            </i>
                            product
                        </div>
                    </div>
                    <div class="nav-body-content">
                        <div class="ac-selector selectbox-creator">
                            <select id="select"></select>
                        </div>
                        <div class="ac-assets">
                            <div id="ac-assets" class="ac-assets-wrapper">
                                
                            </div>
                        </div>
                        <div id="btn-ac-upload" class="ac-upload-button">
                            상품 생성
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>