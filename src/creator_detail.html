<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Auto Cropper</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="./css/common.css" rel="stylesheet" />
        <link href="./subproject/css/creator_detail.css" rel="stylesheet" />

        <script src="http://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>

        <!-- 공통 -->
        <script type="text/javascript" src="./js/common.js"></script>

        <!-- 셀렉트박스 모듈 -->
        <!-- <script type="text/javascript" src="./js/selectbox_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/selectbox.css" /> -->

        <!-- 테이블 모듈 -->
        <script type="text/javascript" src="./js/table_core_module.js"></script>
        <link href="./css/table.css" rel="stylesheet" />

        <!-- 팝업 모듈 -->
        <script type="text/javascript" src="./js/popup_core_module.js"></script>
        <link href="./css/popup.css" rel="stylesheet" />

        <script>
            window.onload = function() {
                const host = window.location.host;

                common.menu();
                common.expander();
                
                // 아이디를 통해 크리에이터 정보 조회
                const id = window.location.search.substring(1).split("=")[1];

                // 데이터 획득
                function fetch(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                const result = JSON.parse(xhr.responseText);
                                const data = result.result;
                                parsing(data);
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/productCreator/" + id, true);
                    xhr.send();
                }
                fetch(id);

                document.querySelector("#asset-file-btn").addEventListener("click", function(e) {
                    e.preventDefault();
                    document.querySelector("#asset-file").click();
                });

                // 파일 업로드
                document.querySelector("#asset-file").addEventListener("change", function(e) {
                    const reader = new FileReader();
                    const filename = e.target.files[0].name;

                    reader.onload = function(event) {
                        const result = event.target.result;
                        const blob_bin = window.atob(result.split(',')[1]);	// base64 데이터 디코딩
                        const array = [];
                        for (let i = 0; i < blob_bin.length; i++) {
                            array.push(blob_bin.charCodeAt(i));
                        }
                        const blob = new Blob([new Uint8Array(array)], {type: 'image/png'});	// Blob 생성

                        const data = new FormData();	// formData 생성
                        data.append("image", blob, filename);	// file data 추가

                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if (xhr.status == 200) {
                                    // 팝업생성 및 이름 값 받기
                                    const obj = JSON.parse(xhr.responseText);
                                    const assetPath = obj.result.assetPath;
                                    const assetFileName = obj.result.assetFileName;

                                    popup_regist.setdata({
                                        "assetPath": assetPath,
                                        "assetFileName": assetFileName
                                    });

                                    // 이미지 파일 데이터
                                    document.querySelector("#preview-img").style.backgroundImage = "url('" + (assetPath + assetFileName) + "')";
                                    document.querySelector("#preview-name").innerText = filename;

                                    popup_regist.open();
                                } else {
                                    alert("파일 업로드에 실패하였습니다.");
                                }
                            }
                        };
                        xhr.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/upload/asset", true);
                        xhr.send(data);
                    }
                    reader.readAsDataURL(e.target.files[0]);
                });

                const popup_regist = new Popup("에셋 등록");
                // 실제 팝업창에 그려질 form 문 작성
                popup_regist.init(function(popup) {
                    const form = document.createElement("form");
                    form.id = "asset-regist";
                    form.style.display = "flex";
                    form.style.flexDirection = "column";
                    form.style.alignItems = "center";
                    form.style.padding = "0px 30px";

                    // 파일 프리뷰(이미지)
                    const preview_div = document.createElement("div");
                    preview_div.style.marginTop = "45px";
                    preview_div.classList.add("popup-file-preview");
                    const preview_img = document.createElement("div");
                    preview_img.id = "preview-img";
                    preview_img.classList.add("popup-file-preview-image");
                    const preview_name = document.createElement("div");
                    preview_name.id = "preview-name";
                    preview_name.classList.add("popup-file-preview-name");
                    preview_div.appendChild(preview_img);
                    preview_div.appendChild(preview_name);

                    // 파일 이름
                    const name_div = document.createElement("div");
                    name_div.style.marginTop = "20px";
                    const name_label = document.createElement("div");
                    name_label.innerText = "파일 이름";
                    name_label.classList.add("popup-label");
                    const name = document.createElement("input");
                    name.id = "asset-name";
                    name.classList.add("popup-input");
                    name.setAttribute("name", "name");
                    name.setAttribute("autocomplete", "off");
                    name_div.appendChild(name_label);
                    name_div.appendChild(name);

                    // 버튼
                    const submit_btn = document.createElement("div");
                    submit_btn.innerText = "완료";
                    submit_btn.classList.add("popup-button");
                    submit_btn.addEventListener("click", function(e) {
                        e.preventDefault();

                        const data = popup_regist.getdata();
                        const asset_name = document.querySelector("#asset-name").value;

                        var param = new FormData();
                        param.append("assetFileName", data.assetFileName);
                        param.append("assetPath", data.assetPath);
                        param.append("name", asset_name);
                        param.append("productCreatorId", id);

                        send(param);
                    }.bind(popup_regist));

                    form.appendChild(preview_div);
                    form.appendChild(name_div);
                    form.appendChild(submit_btn);

                    popup.appendChild(form);
                });

                // 데이터 전송
                function send(param) {
                    var xhr_ = new XMLHttpRequest();
                    xhr_.onreadystatechange = function(e) {
                        if (xhr_.readyState == 4) {
                            if (xhr_.status == 200) {
                                const obj = JSON.parse(xhr_.responseText);
                                fetchAssets(id);
                                popup_regist.close();
                                alert("등록에 성공하였습니다.");
                            } else {
                                alert("등록에 실패하였습니다.");
                            }
                        }
                    }
                    xhr_.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/asset", true);
                    xhr_.send(param);
                }

                // 데이터 파싱[+ UI생성]
                function parsing(data) {
                    const accounts_size = data.productCreatorAccounts.length;
                    document.querySelector("#profile-id").innerText = data.userId;
                    document.querySelector("#profile-name").innerText = data.creatorName;
                    document.querySelector("#accounts-info").innerText = data.productCreatorAccounts[accounts_size - 1].bankName;
                    document.querySelector("#accounts-no").innerHTML = data.productCreatorAccounts[accounts_size - 1].accountNo;
                }

                // 리스트 조회
                function fetchAssets(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                const result = JSON.parse(xhr.responseText);
                                const list = result.content;

                                const asset_list = document.querySelector("#asset-list");
                                asset_list.innerHTML = "";

                                for(item of list) {
                                    let img = item.assetPath + item.assetFileName;
                                    if(host === "127.0.0.1:5500" 
                                            || host === "localhost:5500" 
                                            || host === "192.167.0.177:5500") {
                                                img = "/cropper/src" + img;
                                    }
                                    const asset_item_div = document.createElement("div");
                                    asset_item_div.id = "asset-item";
                                    asset_item_div.style.backgroundImage = "url('" + img + "')";
                                    asset_item_div.style.backgroundPosition = "center";
                                    asset_item_div.style.backgroundSize = "cover";
                                    asset_item_div.classList.add("asset-item");
                                    asset_list.appendChild(asset_item_div);
                                }
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/assets?productCreatorId=" + id, true);
                    xhr.send();
                }
                fetchAssets(id);

                // 계좌 수정
                const popup_editor_account = new Popup("계좌 수정");
                // 실제 팝업창에 그려질 form 문 작성
                popup_editor_account.init(function(popup) {
                    const form = document.createElement("form");
                    form.id = "account-editor";
                    form.style.display = "flex";
                    form.style.flexDirection = "column";
                    form.style.alignItems = "center";
                    form.style.padding = "0px 30px";

                    // 번호
                    const id_div = document.createElement("div");
                    id_div.style.marginTop = "20px";
                    const id_label = document.createElement("div");
                    id_label.innerText = "번호(크리에이터)";
                    id_label.classList.add("popup-label");
                    const id = document.createElement("input");
                    id.id = "editor-creator-id";
                    id.classList.add("popup-input");
                    id.setAttribute("name", "accountNo");
                    id.setAttribute("autocomplete", "off");
                    id.setAttribute("readonly", true);
                    id_div.appendChild(id_label);
                    id_div.appendChild(id);

                    // 계좌 번호
                    const account_no_div = document.createElement("div");
                    account_no_div.style.marginTop = "20px";
                    const account_no_label = document.createElement("div");
                    account_no_label.innerText = "계좌번호";
                    account_no_label.classList.add("popup-label");
                    const account_no = document.createElement("input");
                    account_no.id = "editor-account-no";
                    account_no.classList.add("popup-input");
                    account_no.setAttribute("name", "accountNo");
                    account_no.setAttribute("autocomplete", "off");
                    account_no_div.appendChild(account_no_label);
                    account_no_div.appendChild(account_no);

                    // 은행 코드
                    const bank_code_div = document.createElement("div");
                    bank_code_div.style.marginTop = "20px";
                    const bank_code_label = document.createElement("div");
                    bank_code_label.innerText = "은행코드";
                    bank_code_label.classList.add("popup-label");
                    const bank_code = document.createElement("input");
                    bank_code.id = "editor-bank-code";
                    bank_code.classList.add("popup-input");
                    bank_code.setAttribute("name", "bankCode");
                    bank_code.setAttribute("autocomplete", "off");
                    bank_code_div.appendChild(bank_code_label);
                    bank_code_div.appendChild(bank_code);

                    // 은행 이름
                    const bank_name_div = document.createElement("div");
                    bank_name_div.style.marginTop = "20px";
                    const bank_name_label = document.createElement("div");
                    bank_name_label.innerText = "은행이름";
                    bank_name_label.classList.add("popup-label");
                    const bank_name = document.createElement("input");
                    bank_name.id = "editor-bank-name";
                    bank_name.classList.add("popup-input");
                    bank_name.setAttribute("name", "bankName");
                    bank_name.setAttribute("autocomplete", "off");
                    bank_name_div.appendChild(bank_name_label);
                    bank_name_div.appendChild(bank_name);

                    // 계좌주 이름
                    const owner_name_div = document.createElement("div");
                    owner_name_div.style.marginTop = "20px";
                    const owner_name_label = document.createElement("div");
                    owner_name_label.innerText = "계좌주";
                    owner_name_label.classList.add("popup-label");
                    const owner_name = document.createElement("input");
                    owner_name.id = "editor-owner-name";
                    owner_name.classList.add("popup-input");
                    owner_name.setAttribute("name", "ownerName");
                    owner_name.setAttribute("autocomplete", "off");
                    owner_name_div.appendChild(owner_name_label);
                    owner_name_div.appendChild(owner_name);

                    // 버튼
                    const submit_btn = document.createElement("div");
                    submit_btn.innerText = "완료";
                    submit_btn.classList.add("popup-button");
                    submit_btn.addEventListener("click", function(e) {
                        e.preventDefault();

                        const form = document.querySelector("#account-editor");
                        const creator_id = form.querySelector("#editor-creator-id").value;
                        const account_no = form.querySelector("#editor-account-no").value;
                        const bank_code = form.querySelector("#editor-bank-code").value;
                        const bank_name = form.querySelector("#editor-bank-name").value;
                        const owner_name = form.querySelector("#editor-owner-name").value;
                        
                        var data = new FormData();

                        if(creator_id !== "") {
                            data.append("productCreatorId", creator_id);
                        }
                        if(account_no !== "") {
                            data.append("accountNo", account_no);
                        }
                        if(bank_code !== "") {
                            data.append("bankCode", bank_code);
                        }
                        if(bank_name !== "") {
                            data.append("bankName", bank_name);
                        }
                        if(owner_name !== "") {
                            data.append("ownerName", owner_name);
                        }

                        sendAccount(data);
                    }.bind(popup_regist));

                    form.appendChild(id_div);
                    form.appendChild(account_no_div);
                    form.appendChild(bank_code_div);
                    form.appendChild(bank_name_div);
                    form.appendChild(owner_name_div);
                    form.appendChild(submit_btn);

                    popup.appendChild(form);
                });

                // 데이터 전송
                function sendAccount(data) {
                    var xhr_ = new XMLHttpRequest();
                    xhr_.onreadystatechange = function(e) {
                        if (xhr_.readyState == 4) {
                            if (xhr_.status == 200) {
                                const result = JSON.parse(xhr_.responseText);
                                const data = result.result;
                                parsing(data);
                                popup_editor_account.close();
                                alert("등록에 성공하였습니다.");
                            } else {
                                alert("등록에 실패하였습니다.");
                            }
                        }
                    }
                    xhr_.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/productCreator/account", true);
                    xhr_.send(data);
                }

                // [버튼] 계좌 수정
                document.querySelector("#accounts-regist-btn").addEventListener("click", function(e) {
                    e.preventDefault();
                    const id = window.location.search.substring(1).split("=")[1];
                    fetchAccount(id);
                });

                function fetchAccount(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                const result = JSON.parse(xhr.responseText);
                                const accounts = result.result.productCreatorAccounts;
                                const accounts_size = accounts.length;
                                const account = accounts[accounts_size - 1];

                                const form = document.querySelector("#account-editor");
                                form.querySelector("#editor-creator-id").value = account.productCreatorId;
                                form.querySelector("#editor-account-no").value = account.accountNo;
                                form.querySelector("#editor-bank-code").value = account.bankCode;
                                form.querySelector("#editor-bank-name").value = account.bankName;
                                form.querySelector("#editor-owner-name").value = account.ownerName;

                                popup_editor_account.open();
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/productCreator/" + id, true);
                    xhr.send();
                }
            }
        </script>
    </head>
    <body class="ac">
        <div class="wrapper">
            <div class="head">
                Auto Cropper
            </div>
            <div class="menu">
                <div class="logo">
                    
                </div>
                <div class="platform">
                    AfreecaTV
                </div>
                <div class="menu-item active" data-page="creator">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            people
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Creator
                    </div>
                </div>
                <div class="menu-item" data-page="maker">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            build
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Maker
                    </div>
                </div>
                <div class="menu-item" data-page="package">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            how_to_vote
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Package
                    </div>
                </div>
                <div class="menu-item" data-page="edit">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            crop_free
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Edit
                    </div>
                </div>
                <div class="menu-item" data-page="auto">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            style
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Auto
                    </div>
                </div>
                <div class="menu-item" data-page="product">
                    <div class="menu-item-icon">
                        <i class="material-icons">
                            local_mall
                        </i>
                    </div>
                    <div class="menu-item-text">
                        Product
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="info">
                    <div class="profile">
                        <div id="profile-thumbnail" class="thumbnail"></div>
                        <div class="profile-data">
                            <div class="profiles">
                                <div id="profile-id" class="id"></div>
                                <div id="profile-name" class="name"></div>
                            </div>
                            <div class="accounts">
                                <div id="accounts-info" class="info"></div>
                                <div id="accounts-no" class="number"></div>
                                <div id="accounts-regist-btn" class="accounts-regist-btn"></div>
                            </div>
                        </div>
                    </div>
                    <div class="upload">
                        <input id="asset-file" type="file"/>
                        <div id="asset-file-btn" class="asset-file-btn">파일 업로드 + </div>
                    </div>
                </div>
                <div class="data">
                    <div id="asset-list" class="asset-list">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>