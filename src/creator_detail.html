<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Auto Cropper</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="./css/common.css" rel="stylesheet" />
        <link href="./subproject/css/creator_detail.css" rel="stylesheet" />

        <script src="http://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>

        <!-- 공통 -->
        <script type="text/javascript" src="./js/common.js"></script>

        <!-- 오토크로퍼 모듈 -->
        <script type="text/javascript" src="./js/cropper_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/cropper.css" />

        <!-- 셀렉트박스 모듈 -->
        <script type="text/javascript" src="./js/selectbox_core_module.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/selectbox.css" />

        <!-- 테이블 모듈 -->
        <script type="text/javascript" src="./js/table_core_module.js"></script>
        <link href="./css/table.css" rel="stylesheet" />

        <script>
            window.onload = function() {
                common.menu();
                common.expander();
                
                // 아이디를 통해 크리에이터 정보 조회
                const id = window.location.search.substring(1).split("=")[1];

                // 데이터 획득
                function fetch(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                result = JSON.parse(xhr.responseText);
                                data = result.result;
                                parsing(data);
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/productCreator/" + id, true);
                    xhr.send();
                }
                fetch(id);

                // {"code":0,"result":{"assetPath":"https://ogq-commerce.s3.ap-northeast-2.amazonaws.com/afreeca/asset/6d57c0e9-cd4e-4836-8811-fec89011dfe8.png","assetFileName":"6d57c0e9-cd4e-4836-8811-fec89011dfe8.png"}}

                document.querySelector("#asset-file-btn").addEventListener("click", function(e) {
                    e.preventDefault();
                    document.querySelector("#asset-file").click();
                });

                // 파일 업로드
                document.querySelector("#asset-file").addEventListener("change", function(e) {
                    // console.log(e.target.files[0]);
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const result = event.target.result;
                        const blob_bin = window.atob(result.split(',')[1]);	// base64 데이터 디코딩
                        const array = [];
                        for (let i = 0; i < blob_bin.length; i++) {
                            array.push(blob_bin.charCodeAt(i));
                        }
                        const blob = new Blob([new Uint8Array(array)], {type: 'image/png'});	// Blob 생성

                        var data = new FormData();	// formData 생성
                        data.append("image", blob, 'new_file.png');	// file data 추가

                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if (xhr.status == 200) {
                                    var obj = JSON.parse(xhr.responseText);
                                    var assetPath = obj.result.assetPath;
                                    var assetFileName = obj.result.assetFileName;

                                    var param = new FormData();
                                    param.append('assetFileName', assetFileName);
                                    param.append('assetPath', assetPath);
                                    param.append('name', "테스트");
                                    param.append('productCreatorId', id);

                                    var xhr_ = new XMLHttpRequest();
                                    xhr_.onreadystatechange = function(e) {
                                        if (xhr_.readyState == 4) {
                                            if (xhr_.status == 200) {
                                                var obj = JSON.parse(xhr_.responseText);
                                                fetchAssets(id);
                                            } else {
                                                console.log("Error loading page");
                                            }
                                        }
                                    }
                                    xhr_.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/asset", true);
                                    xhr_.send(param);
                                } else {
                                    console.log("Error loading page");
                                }
                            }
                        };
                        xhr.open("POST", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/upload/asset", true);
                        xhr.send(data);
                    }
                    reader.readAsDataURL(e.target.files[0]);
                });

                // 데이터 파싱[+ UI생성]
                function parsing(data) {
                    document.querySelector("#profile-id").innerText = data.userId;
                    document.querySelector("#profile-name").innerText = data.creatorName;

                    document.querySelector("#accounts-info").innerText = data.productCreatorAccounts[0].bankName + " | " + data.productCreatorAccounts[0].ownerName;
                    document.querySelector("#accounts-no").innerHTML = data.productCreatorAccounts[0].accountNo;
                }

                // 리스트 조회
                function fetchAssets(id) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                result = JSON.parse(xhr.responseText);
                                list = result.content;

                                const asset_list = document.querySelector("#asset-list");
                                asset_list.innerHTML = "";

                                for(item of list) {
                                    const img = item.assetPath + item.assetFileName;
                                    const asset_item_div = document.createElement("div");
                                    asset_item_div.id = "asset-item";
                                    asset_item_div.style.backgroundImage = "url('" + img + "')";
                                    asset_item_div.style.backgroundPosition = "center";
                                    asset_item_div.style.backgroundSize = "cover";
                                    asset_item_div.classList.add("asset-item");
                                    asset_list.appendChild(asset_item_div);
                                }
                            } else {
                                console.log("xhr error");
                            }
                        }
                    }
                    xhr.open("GET", "http://ec2-52-79-159-121.ap-northeast-2.compute.amazonaws.com:8080/api/assets?productCreatorId=" + id, true);
                    xhr.send();
                }
                fetchAssets(id);
            }
        </script>
    </head>
    <body class="ac">
        <div class="wrapper">
            <div class="content">
                <div class="info">
                    <div class="profile">
                        <div id="profile-thumbnail" class="thumbnail"></div>
                        <div id="profile-id" class="id">account</div>
                        <div id="profile-name" class="name">1</div>
                    </div>
                    <div class="accounts">
                        <div id="accounts-info">1</div>
                        <div id="accounts-no">2</div>
                    </div>
                    <div id="accounts-regist-btn" class="accounts-regist-btn">계좌 수정</div>
                </div>
                <div class="data">
                    <input id="asset-file" type="file"/>
                    <div id="asset-file-btn" class="asset-file-btn">파일 업로드</div>
                    <div id="asset-list" class="asset-list">
                    </div>
                </div>
            </div>
            <div class="nav reduction">
                <div class="nav-head">
                    <div class="nav-head-expander">
                        <i class="material-icons">
                            first_page
                        </i>
                    </div>
                    <div class="nav-head-logo">
                        Auto Cropper
                    </div>
                </div>
                <div class="nav-body">
                    <div class="nav-body-menu">
                        <div class="menu-item" data-page="edit">
                            <i class="material-icons">
                                crop_free
                            </i>
                            edit
                        </div>
                        <div class="menu-item" data-page="auto">
                            <i class="material-icons">
                                style
                            </i>
                            auto
                        </div>
                        <div class="menu-item active" data-page="creator">
                            <i class="material-icons">
                                people
                            </i>
                            creator
                        </div>
                        <div class="menu-item" data-page="maker">
                            <i class="material-icons">
                                build
                            </i>
                            maker
                        </div>
                        <div class="menu-item" data-page="product">
                            <i class="material-icons">
                                local_mall
                            </i>
                            product
                        </div>
                    </div>
                    <div class="nav-body-content">
                        
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>